
## Linux下如何释放内存、swap分区满了怎么办！ ##

在Linux系统下，我们一般不需要去释放内存，因为系统已经将内存管理的很好。但是凡事也有例外，有的时候内存会被缓存占用掉，导致系统使用SWAP空间影响性能，此时就需要执行释放内存（清理缓存）的操作了。

Linux系统的缓存机制是相当先进的，他会针对dentry（用于VFS，加速文件路径名到inode的转换）、Buffer Cache（针对磁盘块的读写）和Page Cache（针对文件inode的读写）进行缓存操作。但是在进行了大量文件操作之后，缓存会把内存资源基本用光。但实际上我们文件操作已经完成，这部分缓存已经用不到了。这个时候，我们难道只能眼睁睁的看着缓存把内存空间占据掉么？

**关于内存耗尽的总结:**

 1. 在进程收到OOM之前,内核将刷新文件系统的cache来释放空间.
 2. 将交换区的页面移到磁盘上.
 3. 当内存变少时,虚拟性使每个进程通过交换区来做简单的上下文环境切换.
 4. 当进程消耗尽交换内存后,才会引发out-of-memory(OOM)来kill那些进程.

所以，我们还是有必要来手动进行Linux下释放内存的操作，其实也就是释放缓存的操作了。

要达到释放缓存的目的，我们首先需要了解下关键的配置文件/proc/sys/vm/drop_caches。这个文件中记录了缓存释放的参数，默认值为0，也就是不释放缓存。他的值可以为0~3之间的任意数字，代表着不同的含义：

0 – 不释放
1 – 释放页缓存
2 – 释放dentries和inodes
3 – 释放所有缓存
知道了参数后，我们就可以根据我们的需要，使用下面的指令来进行操作。

首先我们需要使用sync指令，将所有未写的系统缓冲区写到磁盘中，包含已修改的 i-node、已延迟的块 I/O 和读写映射文件。否则在释放缓存的过程中，可能会丢失未保存的文件。

    #sync

接下来，我们需要将需要的参数写进/proc/sys/vm/drop_caches文件中，比如我们需要释放所有缓存，就输入下面的命令：

    #echo 3 > /proc/sys/vm/drop_caches

此指令输入后会立即生效，可以查询现在的可用内存明显的变多了。

要查询当前缓存释放的参数，可以输入下面的指令：

    #cat /proc/sys/vm/drop_caches

**SWAP的概述**

swap的作用可简单描述为:

 - 当内存不够用时,将存储器中的数据块从DRAM移到swap的磁盘空间中,以释放更多的空间给当前进程使用.
当再次需要那些数据时,就可以将swap磁盘中的数据重新移到内存,而将那些不用的数据块从内存移到swap中.
 - 数据从内存移动交换区的行为被称为页面调用,发生在后台的页面调用没有来自应用程序的干涉.
 - swap空间是分页的,每一页的大小和内存页的大小一样.
 - 并不是一定要给每个系统划分SWAP,比如大多数的嵌入式就没有swap.

在执行以上操作以后，查看你的swap分区还是满了，你首先查看一下你实际的内存剩多少空间，然后在查看自己的swap空间用了多少，首先提前保证实际剩余的内存比你的swap的内存的空间要大，然后执行一下操作，否则会宕机的！

1.首先我们停掉swap分区，查看swap分区

    swapon -s 

会查看到你的swap分区是挂在哪里！

2.然后比如说我的是挂到/dev/sda2

    swapoff   /dev/sda2

停止是需要一段时间的，因为他会把内存释放到实际内存当中，

3.最后在启动我们的swap分区

    swapon -a



我们的swap分区内存已经成功释放到了实际内存当中！
